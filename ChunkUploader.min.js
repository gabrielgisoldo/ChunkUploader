var ChunkUploader=function(b){this.defaults={file:null,url:null,timeout:30000,method:"POST",chunk_size:(1024*100),range_start:0,attempts:5,debug:false,send_as_form:false,file_name:"teste",append_on_form:{},onCompleteUpload:function(){},onProgressUpload:function(){},onUploadError:function(c){console.log(c);
},onUploadFail:function(c){console.log(c);},onTimeOut:function(c){console.log(c);},onStartUpload:function(){}};for(var a in this.defaults){this[a]=(b[a]!==undefined)?b[a]:this.defaults[a];
}if("mozSlice" in this.file){this.slice_method="mozSlice";}else{if("webkitSlice" in this.file){this.slice_method="webkitSlice";}else{this.slice_method="slice";
}}this.is_paused=false;this.range_end=this.chunk_size;this.file_size=this.file.size;this.remaining_attempts=this.attempts;this.upload_request=new XMLHttpRequest();
this.upload_request.ontimeout=this._onTimeOut.bind(this);this.upload_request.onload=this._onChunkComplete.bind(this);this.upload_request.onerror=this._retry.bind(this);
this.bytes=0;if("onLine" in navigator){window.addEventListener("online",this._onConnectionFound);window.addEventListener("offline",this._onConnectionLost);
}};ChunkUploader.prototype.get_file=function(){return this.file;};ChunkUploader.prototype.get_url=function(){return this.url;};ChunkUploader.prototype.get_method=function(){return this.method;
};ChunkUploader.prototype.get_chunk_size=function(){return this.chunk_size;};ChunkUploader.prototype.get_range_start=function(){return this.range_start;
};ChunkUploader.prototype.get_range_end=function(){return this.range_end;};ChunkUploader.prototype.get_onCompleteUpload=function(){return this.onCompleteUpload;
};ChunkUploader.prototype.get_onProgressUpload=function(){return this.onProgressUpload;};ChunkUploader.prototype.get_onUploadError=function(){return this.onUploadError;
};ChunkUploader.prototype.get_onStartUpload=function(){return this.onStartUpload;};ChunkUploader.prototype.onTimeOut=function(){return this.onTimeOut;};
ChunkUploader.prototype.get_is_paused=function(){return this.is_paused;};ChunkUploader.prototype.get_upload_request=function(){return this.upload_request;
};ChunkUploader.prototype._onConnectionFound=function(){this.resume();};ChunkUploader.prototype._onConnectionLost=function(){this.pause();};ChunkUploader.prototype._upload=function(){var a=this,b;
b=a.file[a.slice_method](a.range_start,a.range_end);setTimeout(function(){if(a.debug){a.bytes+=b.size;console.log(a.bytes);a._onChunkComplete();}else{a.upload_request.open(a.method,a.url,true);
a.upload_request.timeout=a.timeout;if(!a.send_as_form){a.upload_request.overrideMimeType("application/octet-stream");if(a.range_start!==0){a.upload_request.setRequestHeader("Content-Range","bytes "+a.range_start+"-"+a.range_end+"/"+a.file_size);
}a.upload_request.send(b);}else{form_data=new FormData();form_data.append("file",b,a.file_name);for(var c in a.append_on_form){form_data.append(c,a.append_on_form[c]);
}a.upload_request.send(form_data);}}},200);};ChunkUploader.prototype._onChunkComplete=function(){if(this.upload_request.status<300){this.remaining_attempts=this.attempts;
info={total:this.file_size,loaded:this.range_end};if(this.onProgressUpload&&typeof this.onProgressUpload==="function"){this.onProgressUpload(info);}var a=this;
setTimeout(function(){if(a.range_end===a.file_size){a.onCompleteUpload();return;}a.range_start=a.range_end;a.range_end=a.range_start+a.chunk_size;if(a.range_end>a.file_size){a.range_end=a.file_size;
}if(!this.is_paused){a._upload();}},20);}else{this._retry({status:this.upload_request.status,status_text:this.upload_request.statusText,attempts_remaining:this.remaining_attempts});
}};ChunkUploader.prototype._retry=function(a){if(this.remaining_attempts>0){this.remaining_attempts-=1;if(this.onUploadError&&typeof this.onUploadError==="function"){this.onUploadError(a);
}setTimeout(this._upload(),20);}else{this.upload_request.abort();this.onUploadFail({status:0,status_text:"Exhausted upload attempts.",attempts_remaining:this.remaining_attempts});
}};ChunkUploader.prototype._onTimeOut=function(b){var a=this;if(a.onTimeOut&&typeof a.onTimeOut==="function"){a.onTimeOut(b);}setTimeout(function(){a._retry({status:1,status_text:"Request timed out.",attempts_remaining:a.remaining_attempts});
},20);};ChunkUploader.prototype.start=function(){if(this.onStartUpload&&typeof this.onStartUpload==="function"){this.onStartUpload();}setTimeout(this._upload(),20);
};ChunkUploader.prototype.pause=function(){this.is_paused=true;};ChunkUploader.prototype.resume=function(){this.is_paused=false;this._upload();};
